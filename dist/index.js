"use strict";const e=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)},t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function n(e){const n=function(e){const t=Math.log(e/440)/Math.log(2)*12;return Math.round(t)+69}(e);return{value:n%12,index:n,name:t[n%12],cents:o(e,n),octave:Math.floor(n/12)-1,frequency:e}}function o(e,t){return Math.floor(1200*Math.log(e/function(e){return 440*Math.pow(2,(e-69)/12)}(t))/Math.log(2))}function*s(e,t=((e,t)=>e===t)){const n=e[Symbol.iterator](),{done:o,value:s}=n.next();if(o)return;let i=[];i.push(s);let r=s;for(const e of function(e){return{[Symbol.iterator]:()=>e}}(n))t(e,r)?(i.push(e),r=e):(yield[...i],i=[e],r=e);i.length&&(yield i)}
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/guitar-tuner");const i=Math.pow(2,13),r=Math.ceil(1.5),a={E_4:329.63,B_3:246.94,G_3:196,D_3:146.83,A_2:110,E_2:82.41},l=Object.keys(a),d=new Map(Object.entries(a).map((([e,t])=>[t,e]))),c=Object.values(a).sort(),u=(e,t,n)=>e&&(e[t]=n),m=e=>!!e,y=(e,t)=>(null==e||e.pop(),null==e||e.unshift(t),e),p=e=>{var t,n;return null!==(t=d.get((n=e,c.reduce(((e,t)=>Math.abs(t-n)<Math.abs(e-n)?t:e)))))&&void 0!==t?t:(e=>{throw Error(e)})()};if(!("WebAssembly"in window&&"AudioContext"in window&&"createAnalyser"in AudioContext.prototype&&"createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}Aubio().then((({Pitch:t})=>{!function(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise((function(n,o){t.call(navigator,e,n,o)}))})}();const o=document.getElementById("audio-start"),d=document.getElementById("audio-pause"),c=document.getElementById("tune-up-text"),f=document.getElementById("tune-down-text"),v=document.getElementById("circle-text-play"),h=document.getElementById("circle-text-pluck"),w=document.getElementById("circle-text-note"),g=document.getElementById("match-circle-l"),M=document.getElementById("match-circle-r"),b=document.getElementById("inner-circle"),A=document.getElementById("tuned-jingle");A.volume=.5;const x=new Map(Object.entries(a).map((([e])=>[e,document.getElementById(e)]))),E=new Map(Object.entries(a).map((([e])=>[e,document.getElementById(e+"-fill")])));if(!(o&&d&&c&&f&&v&&h&&w&&g&&M&&b&&A&&[...x.values()].every(m)&&[...E.values()].every(m)))return alert("Expected HTML element missing");let B,C,L,I;d.addEventListener("click",(()=>{L.disconnect(B.destination),C.disconnect(L),B.close(),o.style.display="block",d.style.display="none",v.style.display="inline",h.style.display="none",w.style.display="none",M.style.color="",g.style.transform="translateX(125%)",c.classList.remove("show"),f.classList.remove("show"),e(o,"blob-animation")})),o.addEventListener("click",(()=>{B=new AudioContext,C=B.createAnalyser(),L=B.createScriptProcessor(i,1,1),I=new t("default",i,1,B.sampleRate),navigator.mediaDevices.getUserMedia({audio:!0}).then((t=>{B.createMediaStreamSource(t).connect(C),C.connect(L),L.connect(B.destination),o.style.display="none",d.style.display="block",v.style.display="none",h.style.display="inline",e(d,"shrink-animation"),g.style.visibility="visible";let i=!1,k=!1,D=!1;const S=new Array(r).fill(void 0),_=new Array(18).fill(void 0);let P=new Map(l.map((e=>[e,[]])));L.addEventListener("audioprocess",(e=>{var t,o,r,d;const B=e.inputBuffer.getChannelData(0),C=I.do(B),L=n(C);y(_,L.name);if([...s(_.filter(m))].every((e=>e.length<=3)))i&&(i=!1,v.style.display="none",h.style.display="inline",w.style.display="none",M.style.color="",g.style.transform="translateX(125%)",c.classList.remove("show"),f.classList.remove("show"));else if(L.name&&!Number.isNaN(L.cents)){if(A.paused){i=!0,k=!0;const e=`${L.name}_${L.octave}`,n=p(C),s=C<a[n];e===n&&L.cents<25?(c.classList.remove("show"),f.classList.remove("show")):(c.classList[s?"add":"remove"]("show"),f.classList[s?"remove":"add"]("show"));const l=e===n?L.cents:s?-85:85,m=2*Math.abs(l),y=((e,t=1)=>Math.round(e/t)*t)(l,Math.min(10,Math.round(100/m)));h.style.display="none",w.style.display="inline",w.innerText=n.split("_")[0];const v=null!==(t=P.get(e))&&void 0!==t?t:[];e===n&&0===y&&v.push(0);const B=(j=v.length/6,Math.max(0,Math.min(1,j)));b.style.transition="transform 350ms ease",b.style.transform=`scale(${1-B})`,M.style.transition="color 350ms ease",M.style.color=1===B?"#fff":"#fff8",g.style.transition="transform 350ms ease",g.style.transform=`translateX(${y*(1-B)}%)`,1!==B||D||(A.play(),u(null===(r=null===(o=x.get(n))||void 0===o?void 0:o.querySelector("path"))||void 0===r?void 0:r.style,"fill","rgb(67,111,142)"),u(null===(d=E.get(n))||void 0===d?void 0:d.style,"display","block"),D=!0)}y(S,L.name)}else k&&(b.style.transition="transform 100ms",b.style.transform="scale(1)",k=!1,D=!1,P=new Map(l.map((e=>[e,[]]))));var j}))}))}))}));
//# sourceMappingURL=index.js.map
