(()=>{function ue(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise(function(n,s){t.call(navigator,e,n,s)})})}var A=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)};var de=440,me=69,Ge=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function pe(e){let t=ke(e);return{value:t%12,index:t,name:Ge[t%12],cents:Ue(e,t),octave:Math.floor(t/12)-1,frequency:e}}function ke(e){let t=12*(Math.log(e/de)/Math.log(2));return Math.round(t)+me}function De(e){return de*2**((e-me)/12)}function Ue(e,t){return Math.floor(1200*Math.log(e/De(t))/Math.log(2))}function Pe(e){return{[Symbol.iterator](){return e}}}function*fe(e,t=(n,s)=>n===s){let n=e[Symbol.iterator](),{done:s,value:a}=n.next();if(s)return;let d=[a],f=a;for(let u of Pe(n))t(u,f)?d.push(u):(yield d,d=[u]),f=u;yield d}function*ye(e,t){for(let n of e)if(t(n))yield n;else break}var ge=e=>[].concat(...e),ve=(e,t)=>(e==null||e.pop(),e==null||e.unshift(t),e);var Ee=(e,t,n)=>e.reduce((s,a)=>n(a,t)<n(s,t)?a:s);var j=(e,t,n)=>e&&(e[t]=n),V=e=>!!e;function G(e,t){return new Promise(n=>e.addEventListener(t,n,{once:!0}))}var w=e=>new Promise(t=>setTimeout(t,e));var xe=(e,t)=>{let n=!1,s;return(...a)=>{s=a,n||(t(...a),n=!0,setTimeout(()=>{n=!1,t(...s)},e))}};var be=(e,t=1)=>Math.round(e/t)*t,he=e=>Math.max(0,Math.min(1,e));console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/guitar-tuner");var Me=8192,Xe=185,Re=3500,He=15,$e=5,Fe=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Ye=[1,2,3,4,5,6,7,8],we=ge(Ye.map(e=>Fe.map(t=>`${t}_${e}`))),k={E_4:329.63,B_3:246.94,G_3:196,D_3:146.83,A_2:110,E_2:82.41},p=Object.keys(k),U=500,S={X:"translateX",Y:"translateY"},je=e=>e?Ee(p,e,(t,n)=>Math.abs(we.indexOf(t)-we.indexOf(n))):void 0;ue();var Ve=e=>e[0]!==void 0,q=3,qe=e=>t=>t[0]!==e||t[0]===e&&t.length<=q;if(!("WebAssembly"in window)||!("AudioContext"in window)||!("createAnalyser"in AudioContext.prototype)||!("createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}var Ke="animate"in Element.prototype?e=>e.animate([{transform:"translateY(10vw) scale(0.33)"},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>A(e,"blob-animation"),We="animate"in Element.prototype?e=>e.animate([{transform:"translateY(-10vw) scale(3) "},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>A(e,"shrink-animation");Aubio().then(({Pitch:e})=>{let t=document.getElementById("guitar-tuner"),n=document.getElementById("audio-start"),s=document.getElementById("audio-pause"),a=document.getElementById("tune-up-text"),d=document.getElementById("tune-down-text"),f=document.getElementById("circle-text-play"),u=document.getElementById("circle-text-pluck"),I=document.getElementById("circle-text-complete"),C=document.getElementById("circle-text-error"),i=document.getElementById("circle-note"),v=document.getElementById("match-circle-l"),Ne=document.getElementById("match-circle-r"),E=document.getElementById("inner-circle"),b=document.getElementById("tuned-jingle");b.volume=.001;let Te=.5,K=new Map(Object.entries(k).map(([r])=>[r,document.getElementById(r)])),D=new Map(Object.entries(k).map(([r])=>[r,document.getElementById(`${r}-fill`)]));if(!t||!n||!s||!a||!d||!f||!u||!I||!C||!i||!v||!Ne||!E||!b||![...K.values()].every(V)||![...D.values()].every(V))return alert("Expected HTML element missing");let L=xe(500,(r,g)=>{r?(a.classList.remove("show"),d.classList.remove("show")):(a.classList[g?"add":"remove"]("show"),d.classList[g?"remove":"add"]("show"))}),y,B,x,_,P,X;v.style.transform=`${S.Y}(125%)`;let W=()=>{n.style.display="block",s.style.display="none",f.style.opacity="1",u.style.opacity="0",i.style.opacity="0",i.style.color="",v.style.transform=`${S.Y}(125%)`,a.classList.remove("show"),d.classList.remove("show"),L(!0),Ke(n)};s.addEventListener("click",async()=>{clearInterval(X),W(),await Promise.race([G(n,"animationend"),w(250)]),x.disconnect(y.destination),B.disconnect(x),y.close(),P.getTracks().forEach(r=>r.stop())}),n.addEventListener("click",async()=>{await b.play(),await w(1600),b.volume=Te},{once:!0}),n.addEventListener("click",async()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),n.style.display="none",s.style.display="block",We(s),await Promise.race([G(s,"animationend"),w(250)]),y=new AudioContext,B=y.createAnalyser(),x=y.createScriptProcessor(Me,1,1),_=new e("default",Me,1,y.sampleRate),_.setSilence(-55);try{P=await navigator.mediaDevices.getUserMedia({audio:!0}),y.createMediaStreamSource(P).connect(B),B.connect(x),x.connect(y.destination),f.style.opacity="0",C.style.opacity="0",u.style.opacity="1";let r=!1,g=!1,Z=!1,R=!1,J,l,Q,z=new Array(He).fill(void 0),N=new Map(p.map(c=>[c,[]])),h=new Map(p.map(c=>[c,!1])),Ae=(await G(x,"audioprocess")).inputBuffer.getChannelData(0),H=_.do(Ae);x.addEventListener("audioprocess",c=>{let M=c.inputBuffer.getChannelData(0);H=_.do(M)}),X=setInterval(()=>{var ee,te,ne,oe,se,re;if(R)return;let c=pe(H),M=c.name?`${c.name}_${c.octave}`:void 0;ve(z,M);let $=[...fe(z)],F=$.filter(Ve);l=je((ee=F.find(o=>o.length>q))==null?void 0:ee[0]);let Se=F.every(o=>o.length<=q),Ie=[...ye(F,qe(l))].length>=3;if(Se&&r)l=void 0,r=!1,f.style.opacity="0",u.style.opacity="1",i.style.opacity="0",i.style.color="",v.style.transform=`${S.Y}(125%)`,L(!0);else if(l&&!Number.isNaN(c.cents)&&b.paused){r=!0,g=!0;let o=l,m=H<k[o],ae=M===o?c.cents:m?-50:50,Be=Math.abs(ae)*2,_e=Math.min(10,Math.round(100/Be)),ie=be(ae,_e),le=(te=N.get(o))!=null?te:[],Oe=(ne=h.get(o))!=null?ne:!1;M===o&&ie===0&&le.push(0);let O=he(le.length/$e),ce=ie*(1-O);L(M===o&&ce===0,m),u.style.opacity="0",i.style.opacity="1";let Y=o.split("_")[0];J!==Y&&(i.innerText=Y),J=Y,E.style.transition=`transform ${U}ms ease`,E.style.transform=`scale(${1-O})`,i.style.transition=`color ${U}ms ease`,i.style.color=O===1?"#fbfbfb":"#fbfbfb88",v.style.transition=`transform ${U}ms ease`,v.style.transform=`${S.Y}(${-ce}%)`,O===1&&!Oe&&(j((se=(oe=K.get(o))==null?void 0:oe.querySelector("path"))==null?void 0:se.style,"fill","rgb(67,111,142)"),j((re=D.get(o))==null?void 0:re.style,"display","block"),h.set(o,!0),w(U).then(()=>{b.play(),A(i,"explode"),[...D.values()].every(T=>T.style.display==="block")&&!Z&&(Z=!0,R=!0,t.classList.add("all-tuned-up"),i.style.opacity="0",I.style.opacity="1",A(I,"explode"),l=void 0,h=new Map(p.map(T=>[T,!1])),N=new Map(p.map(T=>[T,[]])),v.style.transform=`${S.Y}(125%)`,L(!0),w(Re).then(()=>{R=!1,t.classList.remove("all-tuned-up"),I.style.opacity="0"}))}))}let Ce=$[0][0]===void 0&&$[0].length>=2,Le=Q!==l;Q=l,g&&Le?(E.style.transition="transform 100ms",E.style.transform="scale(1)",g=!1,h=new Map(p.map(o=>{var m;return o===l?[o,(m=h.get(o))!=null?m:!1]:[o,!1]})),N=new Map(p.map(o=>{var m;return o===l?[o,(m=N.get(o))!=null?m:[]]:[o,[]]}))):g&&(Ce||Ie)&&(l=void 0,E.style.transition="transform 100ms",E.style.transform="scale(1)",g=!1,h=new Map(p.map(o=>[o,!1])),N=new Map(p.map(o=>[o,[]])))},Xe)}catch(r){clearInterval(X),W(),f.style.opacity="0",C.innerText=r.message,C.style.opacity="1"}})});})();
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */
