(()=>{function ie(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise(function(n,r){t.call(navigator,e,n,r)})})}var _=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)};var le=440,ce=69,Be=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function ue(e){let t=Le(e);return{value:t%12,index:t,name:Be[t%12],cents:Oe(e,t),octave:Math.floor(t/12)-1,frequency:e}}function Le(e){let t=12*(Math.log(e/le)/Math.log(2));return Math.round(t)+ce}function Ge(e){return le*2**((e-ce)/12)}function Oe(e,t){return Math.floor(1200*Math.log(e/Ge(t))/Math.log(2))}function ke(e){return{[Symbol.iterator](){return e}}}function*de(e,t=(n,r)=>n===r){let n=e[Symbol.iterator](),{done:r,value:a}=n.next();if(r)return;let d=[a],m=a;for(let l of ke(n))t(l,m)?d.push(l):(yield d,d=[l]),m=l;yield d}function*me(e,t){for(let n of e)if(t(n))yield n;else break}var pe=e=>[].concat(...e),fe=(e,t)=>(e==null||e.pop(),e==null||e.unshift(t),e);var ye=(e,t,n)=>e.reduce((r,a)=>n(a,t)<n(r,t)?a:r);var R=(e,t,n)=>e&&(e[t]=n),$=e=>!!e;function B(e,t){return new Promise(n=>e.addEventListener(t,n,{once:!0}))}var L=e=>new Promise(t=>setTimeout(t,e));var ge=(e,t)=>{let n=!1,r;return(...a)=>{r=a,n||(t(...a),n=!0,setTimeout(()=>{n=!1,t(...r)},e))}};var ve=(e,t=1)=>Math.round(e/t)*t,xe=e=>Math.max(0,Math.min(1,e));console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/guitar-tuner");var Ee=8192,De=185,Pe=15,Ue=5,Xe=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Fe=[1,2,3,4,5,6,7,8],be=pe(Fe.map(e=>Xe.map(t=>`${t}_${e}`))),O={E_4:329.63,B_3:246.94,G_3:196,D_3:146.83,A_2:110,E_2:82.41},E=Object.keys(O),G=500,k={X:"translateX",Y:"translateY"},Re=e=>e?ye(E,e,(t,n)=>Math.abs(be.indexOf(t)-be.indexOf(n))):void 0;ie();var $e=e=>e[0]!==void 0,H=3,He=e=>t=>t[0]!==e||t[0]===e&&t.length<=H;if(!("WebAssembly"in window)||!("AudioContext"in window)||!("createAnalyser"in AudioContext.prototype)||!("createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}Aubio().then(({Pitch:e})=>{let t=document.getElementById("guitar-tuner"),n=document.getElementById("audio-start"),r=document.getElementById("audio-pause"),a=document.getElementById("tune-up-text"),d=document.getElementById("tune-down-text"),m=document.getElementById("circle-text-play"),l=document.getElementById("circle-text-pluck"),w=document.getElementById("circle-text-error"),c=document.getElementById("circle-note"),b=document.getElementById("match-circle-l"),he=document.getElementById("match-circle-r"),g=document.getElementById("inner-circle"),h=document.getElementById("tuned-jingle");h.volume=.001;let Me=.5,q=new Map(Object.entries(O).map(([s])=>[s,document.getElementById(s)])),Y=new Map(Object.entries(O).map(([s])=>[s,document.getElementById(`${s}-fill`)]));if(!t||!n||!r||!a||!d||!m||!l||!w||!c||!b||!he||!g||!h||![...q.values()].every($)||![...Y.values()].every($))return alert("Expected HTML element missing");let D=ge(500,(s,f)=>{s?(a.classList.remove("show"),d.classList.remove("show")):(a.classList[f?"add":"remove"]("show"),d.classList[f?"remove":"add"]("show"))}),p,N,v,T,P,U;b.style.transform=`${k.Y}(125%)`;let j=()=>{n.style.display="block",r.style.display="none",m.style.opacity="1",l.style.opacity="0",c.style.opacity="0",c.style.color="",b.style.transform=`${k.Y}(125%)`,a.classList.remove("show"),d.classList.remove("show"),D(!0),"animate"in Element.prototype?n.animate([{transform:"translateY(10vw) scale(0.33)"},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):_(n,"blob-animation")};r.addEventListener("click",async()=>{clearInterval(U),j(),await Promise.race([B(n,"animationend"),L(250)]),v.disconnect(p.destination),N.disconnect(v),p.close(),P.getTracks().forEach(s=>s.stop())}),n.addEventListener("click",async()=>{await h.play(),await L(1600),h.volume=Me},{once:!0}),n.addEventListener("click",async()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),n.style.display="none",r.style.display="block","animate"in Element.prototype?r.animate([{transform:"translateY(-10vw) scale(3) "},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):_(r,"shrink-animation"),await Promise.race([B(r,"animationend"),L(250)]),p=new AudioContext,N=p.createAnalyser(),v=p.createScriptProcessor(Ee,1,1),T=new e("default",Ee,1,p.sampleRate),T.setSilence(-55);try{P=await navigator.mediaDevices.getUserMedia({audio:!0}),p.createMediaStreamSource(P).connect(N),N.connect(v),v.connect(p.destination),m.style.opacity="0",w.style.opacity="0",l.style.opacity="1";let s=!1,f=!1,K,u,V,W=new Array(Pe).fill(void 0),A=new Map(E.map(y=>[y,[]])),M=new Map(E.map(y=>[y,!1])),we=(await B(v,"audioprocess")).inputBuffer.getChannelData(0),Z={frequency:T.do(we)};v.addEventListener("audioprocess",y=>{let x=y.inputBuffer.getChannelData(0);Z.frequency=T.do(x)}),U=setInterval(()=>{var J,Q,z,ee,te,ne;let{frequency:y}=Z,x=ue(y),S=x.name?`${x.name}_${x.octave}`:void 0;fe(W,S);let I=[...de(W)],X=I.filter($e);u=Re((J=X.find(o=>o.length>H))==null?void 0:J[0]);let Ne=X.every(o=>o.length<=H),Te=[...me(X,He(u))].length>=3;if(console.log(I.map(o=>o.map(i=>i===void 0?"-":i.includes("#")?i.charAt(0).toLocaleLowerCase():i.charAt(0)).join("")).join("")),Ne&&s)u=void 0,s=!1,m.style.opacity="0",l.style.opacity="1",c.style.opacity="0",c.style.color="",b.style.transform=`${k.Y}(125%)`,D(!0);else if(u&&!Number.isNaN(x.cents)&&h.paused){s=!0,f=!0;let o=u,i=y<O[o],oe=S===o?x.cents:i?-50:50,Ie=Math.abs(oe)*2,Ce=Math.min(10,Math.round(100/Ie)),re=ve(oe,Ce),se=(Q=A.get(o))!=null?Q:[],_e=(z=M.get(o))!=null?z:!1;S===o&&re===0&&se.push(0);let C=xe(se.length/Ue),ae=re*(1-C);D(S===o&&ae===0,i),l.style.opacity="0",c.style.opacity="1";let F=o.split("_")[0];K!==F&&(c.innerText=F),K=F,g.style.transition=`transform ${G}ms ease`,g.style.transform=`scale(${1-C})`,c.style.transition=`color ${G}ms ease`,c.style.color=C===1?"#fbfbfb":"#fbfbfb88",b.style.transition=`transform ${G}ms ease`,b.style.transform=`${k.Y}(${-ae}%)`,C===1&&!_e&&(setTimeout(()=>(h.play(),_(c,"explode")),G),R((te=(ee=q.get(o))==null?void 0:ee.querySelector("path"))==null?void 0:te.style,"fill","rgb(67,111,142)"),R((ne=Y.get(o))==null?void 0:ne.style,"display","block"),M.set(o,!0))}let Ae=I[0][0]===void 0&&I[0].length>=2,Se=V!==u;V=u,f&&Se?(g.style.transition="transform 100ms",g.style.transform="scale(1)",f=!1,M=new Map(E.map(o=>{var i;return o===u?[o,(i=M.get(o))!=null?i:!1]:[o,!1]})),A=new Map(E.map(o=>{var i;return o===u?[o,(i=A.get(o))!=null?i:[]]:[o,[]]}))):f&&(Ae||Te)&&(u=void 0,g.style.transition="transform 100ms",g.style.transform="scale(1)",f=!1,M=new Map(E.map(o=>[o,!1])),A=new Map(E.map(o=>[o,[]])))},De)}catch(s){clearInterval(U),j(),m.style.opacity="0",w.innerText=s.message,w.style.opacity="1"}})});})();
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */
